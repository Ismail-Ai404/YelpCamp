<!-- @format -->

<% layout("layouts/boilerplate") %>
<link rel="stylesheet" href="/stylesheets/stars.css" />

<div class="container mt-4">
     <div class="row g-4">
          <!-- <h1><%= JSON.stringify(campground.geometry.coordinates) %></h1> -->
          <!-- Left Column: Campground Info -->
          <div class="col-md-6">
               <div class="card shadow-sm mb-3 border-0">
                    <% if(campground.images) { %>
                    <div
                         id="campgroundCarousel"
                         class="carousel slide"
                         data-bs-ride="carousel"
                    >
                         <div class="carousel-inner">
                              <% campground.images.forEach((img, i) => { %>
                              <div
                                   class="carousel-item <%= i === 0 ? 'active' : '' %>"
                              >
                                   <img
                                        src="<%= img.url %>"
                                        class="d-block w-100"
                                        alt="Campground Image <%= i + 1 %>"
                                   />
                              </div>
                              <% }) %>
                         </div>
                         <% if(campground.images.length > 1) { %>
                         <button
                              class="carousel-control-prev"
                              type="button"
                              data-bs-target="#campgroundCarousel"
                              data-bs-slide="prev"
                         >
                              <span
                                   class="carousel-control-prev-icon"
                                   aria-hidden="true"
                              ></span>
                              <span class="visually-hidden">Previous</span>
                         </button>
                         <button
                              class="carousel-control-next"
                              type="button"
                              data-bs-target="#campgroundCarousel"
                              data-bs-slide="next"
                         >
                              <span
                                   class="carousel-control-next-icon"
                                   aria-hidden="true"
                              ></span>
                              <span class="visually-hidden">Next</span>
                         </button>
                         <% } %>
                    </div>

                    <% } else { %>
                    <img
                         src="https://via.placeholder.com/800x400?text=No+Image"
                         class="card-img-top w-100"
                         alt="No Image"
                         style="height: 200px; object-fit: cover"
                    />
                    <% } %>

                    <div class="card-body p-3">
                         <h4 class="card-title mb-2">
                              <%= campground.title %>
                         </h4>
                         <p class="text-muted mb-1 small">
                              <i class="bi bi-geo-alt-fill me-1"></i>
                              <strong>Location:</strong> <%= campground.location
                              %>
                         </p>

                         <% if(campground.description) { %>
                         <p class="card-text mb-2 small">
                              <i class="bi bi-info-circle me-1"></i>
                              <strong>Description:</strong> <%=
                              campground.description %>
                         </p>
                         <% } %> <% if(campground.price) { %>
                         <span class="badge bg-success fs-7 mb-2 me-2">
                              <i class="bi bi-cash-coin me-1"></i>
                              $<%= campground.price %>/night
                         </span>
                         <% } %> <% if(campground.author) { %>
                         <span class="badge bg-success fs-7 mb-2">
                              <i class="bi bi-person-fill me-1"></i>
                              Made by <%= campground.author.username %>
                         </span>
                         <% } %>

                         <div class="mt-2 d-flex flex-wrap gap-2">
                              <a
                                   href="/campgrounds"
                                   class="btn btn-warning btn-sm"
                              >
                                   <i class="bi bi-arrow-left-circle me-1"></i>
                                   Back
                              </a>

                              <% if (currentUser &&
                              campground.author._id.equals(currentUser._id)) {
                              %>
                              <a
                                   href="/campgrounds/<%= campground._id %>/edit"
                                   class="btn btn-primary btn-sm"
                              >
                                   <i class="bi bi-pencil-square me-1"></i> Edit
                              </a>
                              <form
                                   action="/campgrounds/<%= campground._id %>?_method=DELETE"
                                   method="POST"
                                   style="display: inline"
                                   onsubmit="return confirm('Are you sure you want to delete this campground?');"
                              >
                                   <button
                                        type="submit"
                                        class="btn btn-danger btn-sm"
                                   >
                                        <i class="bi bi-trash-fill me-1"></i>
                                        Delete
                                   </button>
                              </form>
                              <% } %>
                         </div>
                    </div>
               </div>
          </div>

          <!-- Right Column: Leave a Review + Reviews -->
          <div class="col-md-6">
               <!-- Map container: put this where you want the map, e.g. above reviews -->
               <div
                    id="map"
                    style="width: 100%; height: 300px; margin-bottom: 20px"
               ></div>
               <% if (currentUser) { %>
               <!-- Rating Form -->
               <div class="card shadow-sm mb-3 border-0">
                    <div class="card-body p-3">
                         <h5 class="card-title mb-2">Leave a Rating</h5>
                         <form
                              action="/campgrounds/<%= campground._id %>/reviews"
                              method="POST"
                              novalidate
                              class="needs-validation"
                         >
                              <!-- Rating -->
                              <div class="">
                                   <fieldset class="starability-checkmark">
                                        <input
                                             type="radio"
                                             id="no-rate"
                                             class="input-no-rate"
                                             name="review[rating]"
                                             value="1"
                                             checked
                                             aria-label="No rating."
                                        />
                                        <input
                                             type="radio"
                                             id="first-rate1"
                                             name="review[rating]"
                                             value="1"
                                        />
                                        <label
                                             for="first-rate1"
                                             title="Terrible"
                                             >1 star</label
                                        >
                                        <input
                                             type="radio"
                                             id="first-rate2"
                                             name="review[rating]"
                                             value="2"
                                        />
                                        <label
                                             for="first-rate2"
                                             title="Not good"
                                             >2 stars</label
                                        >
                                        <input
                                             type="radio"
                                             id="first-rate3"
                                             name="review[rating]"
                                             value="3"
                                        />
                                        <label for="first-rate3" title="Average"
                                             >3 stars</label
                                        >
                                        <input
                                             type="radio"
                                             id="first-rate4"
                                             name="review[rating]"
                                             value="4"
                                        />
                                        <label
                                             for="first-rate4"
                                             title="Very good"
                                             >4 stars</label
                                        >
                                        <input
                                             type="radio"
                                             id="first-rate5"
                                             name="review[rating]"
                                             value="5"
                                        />
                                        <label for="first-rate5" title="Amazing"
                                             >5 stars</label
                                        >
                                   </fieldset>
                              </div>

                              <!-- Review -->
                              <div class="mb-2">
                                   <label for="review" class="form-label small">
                                        <i class="bi bi-chat-dots me-1"></i>
                                        Your Review
                                   </label>
                                   <textarea
                                        class="form-control form-control-sm"
                                        id="review"
                                        name="review[body]"
                                        rows="2"
                                        placeholder="Write something..."
                                        maxlength="500"
                                   ></textarea>
                              </div>

                              <button
                                   type="submit"
                                   class="btn btn-success btn-sm"
                              >
                                   <i class="bi bi-send-fill me-1"></i> Submit
                              </button>
                         </form>
                    </div>
               </div>
               <% } %>

               <!-- Reviews Section -->
               <div class="card shadow-sm mb-3 border-0">
                    <div class="card-body p-3">
                         <h5 class="card-title mb-3">
                              <i class="bi bi-chat-square-text me-1"></i>
                              Reviews
                         </h5>

                         <% if(campground.reviews && campground.reviews.length >
                         0) { %>
                         <div class="d-flex flex-column gap-2">
                              <% campground.reviews.forEach(review => { %>
                              <div
                                   class="p-2 rounded-2 shadow-sm border bg-light"
                              >
                                   <div
                                        class="d-flex justify-content-between align-items-center mb-1"
                                   >
                                        <p
                                             class="starability-result mt-1"
                                             data-rating="<%= review.rating %>"
                                        >
                                             Rated: <%= review.rating %> stars
                                        </p>
                                        <small class="text-muted">
                                             <i
                                                  class="bi bi-clock-history me-1"
                                             ></i>
                                             <%= review.createdAt ?
                                             review.createdAt.toDateString() :
                                             "Recently" %>
                                        </small>
                                   </div>
                                   <p class="mb-0 text-secondary fs-7">
                                        <i
                                             class="bi bi-chat-left-quote me-1 text-primary"
                                        ></i>
                                        <%= review.body && review.body.trim()
                                        !== "" ? review.body : '"No comment."'
                                        %>
                                   </p>

                                   <% if (currentUser && review.author &&
                                   review.author._id.equals(currentUser._id)) {
                                   %>

                                   <div
                                        class="d-flex justify-content-between align-items-center mt-2"
                                   >
                                        <small class="text-muted d-block mt-1">
                                             <i
                                                  class="bi bi-person-circle me-1"
                                             ></i>
                                             Reviewed by You
                                        </small>
                                   </div>
                                   <div>
                                        <form
                                             action="/campgrounds/<%= campground._id %>/reviews/<%= review._id %>?_method=DELETE"
                                             method="POST"
                                        >
                                             <button
                                                  type="submit"
                                                  class="btn text-danger p-0"
                                             >
                                                  <i
                                                       class="bi bi-trash me-1"
                                                  ></i>
                                                  Delete
                                             </button>
                                        </form>
                                   </div>
                                   <% } else if (true) { %>
                                   <div
                                        class="d-flex justify-content-between align-items-center mt-2"
                                   >
                                        <small class="text-muted d-block mt-1">
                                             <i
                                                  class="bi bi-person-circle me-1"
                                             ></i>
                                             Reviewed by <%=
                                             review.author.username %>
                                        </small>
                                   </div>
                                   <% } %>
                              </div>
                              <% }) %>
                         </div>
                         <% } else { %>
                         <p class="text-muted fs-7">
                              <i class="bi bi-emoji-frown me-1"></i> No reviews
                              yet. Be the first!
                         </p>
                         <% } %>
                    </div>
               </div>
          </div>
     </div>
</div>

<!-- Pass API key from server to front-end -->
<script>
     const mapToken = "<%= process.env.MAPTILER_API_KEY %>";
     const campgroundCoords = <%- JSON.stringify(campground.geometry.coordinates)  %>;
     const campground= <%- JSON.stringify(campground) %>;
</script>

<!-- Include your external JS file -->
<script src="/javascripts/showMap.js"></script>
