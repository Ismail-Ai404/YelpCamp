<!-- @format -->

<% layout("layouts/boilerplate") %>

<div class="container mt-4">
     <div class="row g-4">
          <!-- Left Column: Campground Info -->
          <div class="col-md-6">
               <div class="card shadow-sm mb-3 border-0">
                    <% if(campground.image) { %>
                    <img
                         src="<%= campground.image %>"
                         class="card-img-top w-100"
                         alt="<%= campground.title %>"
                         style="object-fit: cover;"
                    />
                    <% } else { %>
                    <img
                         src="https://via.placeholder.com/800x400?text=No+Image"
                         class="card-img-top w-100"
                         alt="No Image"
                         style="height: 200px; object-fit: cover;"
                    />
                    <% } %>

                    <div class="card-body p-3">
                         <h4 class="card-title mb-2"><%= campground.title %></h4>
                         <p class="text-muted mb-1 small">
                              <i class="bi bi-geo-alt-fill me-1"></i>
                              <strong>Location:</strong> <%= campground.location %>
                         </p>

                         <% if(campground.description) { %>
                         <p class="card-text mb-2 small">
                              <i class="bi bi-info-circle me-1"></i>
                              <strong>Description:</strong> <%= campground.description %>
                         </p>
                         <% } %> 

                         <% if(campground.price) { %>
                         <span class="badge bg-success fs-7 mb-2 me-2">
                              <i class="bi bi-cash-coin me-1"></i>
                              $<%= campground.price %>/night
                         </span>
                         <% } %>
                         <% if(campground.author) { %>
                         <span class="badge bg-success fs-7 mb-2">
                              <i class="bi bi-person-fill me-1"></i>
                              Made by <%= campground.author.username %>
                         </span>
                         <% } %>
                         

                         <div class="mt-2 d-flex flex-wrap gap-2">
                              <a href="/campgrounds" class="btn btn-warning btn-sm">
                                   <i class="bi bi-arrow-left-circle me-1"></i> Back
                              </a>

                              <% if (currentUser && campground.author._id.equals(currentUser._id)) { %>
                                   <a href="/campgrounds/<%= campground._id %>/edit" class="btn btn-primary btn-sm">
                                        <i class="bi bi-pencil-square me-1"></i> Edit
                                   </a>
                              <form
                                   action="/campgrounds/<%= campground._id %>?_method=DELETE"
                                   method="POST"
                                   style="display:inline"
                                   onsubmit="return confirm('Are you sure you want to delete this campground?');"
                              >
                                   <button type="submit" class="btn btn-danger btn-sm">
                                        <i class="bi bi-trash-fill me-1"></i> Delete
                                   </button>
                              </form>
                              <% } %>

                         </div>
                    </div>
               </div>
          </div>
          
           
          
          <!-- Right Column: Leave a Review + Reviews -->
          <div class="col-md-6">
               <% if (currentUser) { %>
               <!-- Rating Form -->
               <div class="card shadow-sm mb-3 border-0">
                    <div class="card-body p-3">
                         <h5 class="card-title mb-2">
                              <i class="bi bi-star-half me-1"></i> Leave a Rating
                         </h5>
                         <form
                              action="/campgrounds/<%= campground._id %>/reviews"
                              method="POST"
                              novalidate
                              class="needs-validation"
                         >
                              <!-- Rating -->
                              <div class="mb-2">
                                   <label for="rating" class="form-label small">
                                        <i class="bi bi-star-fill text-warning me-1"></i> Rating
                                   </label>
                                   <select
                                        class="form-select form-select-sm"
                                        id="rating"
                                        name="review[rating]"
                                        required
                                   >
                                        <option value="" disabled selected>Choose...</option>
                                        <option value="1">⭐ 1 - Poor</option>
                                        <option value="2">⭐⭐ 2 - Fair</option>
                                        <option value="3">⭐⭐⭐ 3 - Good</option>
                                        <option value="4">⭐⭐⭐⭐ 4 - Very Good</option>
                                        <option value="5">⭐⭐⭐⭐⭐ 5 - Excellent</option>
                                   </select>
                              </div>

                              <!-- Review -->
                              <div class="mb-2">
                                   <label for="review" class="form-label small">
                                        <i class="bi bi-chat-dots me-1"></i> Your Review
                                   </label>
                                   <textarea
                                        class="form-control form-control-sm"
                                        id="review"
                                        name="review[body]"
                                        rows="2"
                                        placeholder="Write something..."
                                        maxlength="500"
                                   ></textarea>
                              </div>

                              <button type="submit" class="btn btn-success btn-sm">
                                   <i class="bi bi-send-fill me-1"></i> Submit
                              </button>
                         </form>
                    </div>
               </div>
               <% } %>

               <!-- Reviews Section -->
               <div class="card shadow-sm mb-3 border-0">
                    <div class="card-body p-3">
                         <h5 class="card-title mb-3">
                              <i class="bi bi-chat-square-text me-1"></i> Reviews
                         </h5>

                         <% if(campground.reviews && campground.reviews.length > 0) { %>
                              <div class="d-flex flex-column gap-2">
                                   <% campground.reviews.forEach(review => { %>
                                        <div class="p-2 rounded-2 shadow-sm border bg-light">
                                             <div class="d-flex justify-content-between align-items-center mb-1">
                                                  <div class="text-warning small">
                                                       <% for(let i=0; i<review.rating; i++) { %>
                                                            <i class="bi bi-star-fill"></i>
                                                       <% } %>
                                                       <% for(let i=review.rating; i<5; i++) { %>
                                                            <i class="bi bi-star"></i>
                                                       <% } %>
                                                  </div>
                                                  <small class="text-muted">
                                                       <i class="bi bi-clock-history me-1"></i>
                                                       <%= review.createdAt ? review.createdAt.toDateString() : "Recently" %>
                                                  </small>
                                             </div>
                                             <p class="mb-0 text-secondary fs-7">
                                                  <i class="bi bi-chat-left-quote me-1 text-primary"></i>
                                                  <%= review.body && review.body.trim() !== "" ? review.body : '"No comment."' %>
                                             </p>

                                             <% if (currentUser && review.author && review.author._id.equals(currentUser._id)) { %>

                                                  <div class="d-flex justify-content-between align-items-center mt-2">
                                                       <small class="text-muted d-block mt-1">
                                                            <i class="bi bi-person-circle me-1"></i>
                                                            Reviewed by You
                                                       </small>
                                                  </div>
                                                  <div>
                                                       <form action="/campgrounds/<%= campground._id %>/reviews/<%= review._id %>?_method=DELETE" method="POST">
                                                            <button type="submit" class="btn text-danger p-0">
                                                                 <i class="bi bi-trash me-1"></i> Delete
                                                            </button>
                                                       </form>
                                                  </div>
                                             <% } else if (true) { %>
                                                  <div class="d-flex justify-content-between align-items-center mt-2">
                                                       <small class="text-muted d-block mt-1 ">
                                                            <i class="bi bi-person-circle me-1"></i>
                                                            Reviewed by <%= review.author.username %>
                                                       </small>
                                                  </div>
                                             <% } %>
                                        </div>
                                   <% }) %>
                              </div>
                         <% } else { %>
                              <p class="text-muted fs-7">
                                   <i class="bi bi-emoji-frown me-1"></i> No reviews yet. Be the first!
                              </p>
                         <% } %>
                    </div>
               </div>
          </div>
     </div>
</div>